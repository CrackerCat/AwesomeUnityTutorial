# shader 着色器

## 1. 概述

着色器是一段脚本程序，在 GPU 上运行。

它应用材质中包含的属性来将 3D 对象的网格渲染到屏幕上的 2D 图像。每个着色器都是为特定的渲染管道编写的。

![](../imgs/f9a7bbfa-9e76-42f3-bf2c-7ef4bdd896a9_CC_Shad_Shdrs_1.png.2000x0x1.png)

您使用的着色器取决于您的渲染管道。在 Unity 中，每个模板都带有专门为模板中使用的渲染管道设计的着色器。

着色器可以变化很大，提供可以应用于项目的各种视觉样式。

## 2. 分类

### 2.1 基本功能分类

1. 片元着色 fragment shading:  
   也称为像素着色，是表示网格表面以产生二维图像中每个像素的颜色的着色。

2. 顶点着色 vertex shading:  
   作用于网格的顶点，通常改变它们的位置以使表面移动或变换。

### 2.2 Unity 中使用方式分类

在 Unity 中，着色器根据使用方式不同，分为三大类。每个类别的用途不同，使用方式也不同。

1. 内嵌着色器：  
   作为图形管线一部分的着色器是最常见的着色器类型。它们执行一些计算来确定屏幕上像素的颜色。在 Unity 中，通常是通过 Shader 对象使用这种类型的着色器。
2. 计算着色器：  
   在常规图形管线之外，在 GPU 上执行计算。
3. 光线追踪着色器：  
   执行与光线追踪相关的计算。

## 3. 相关术语：

- 着色器或者着色器程序 - 在 GPU 上运行的程序。除非另有说明，否则这意味着着色器程序是图形管线的一部分。
- Shader 对象 - Shader 类的一个实例。Shader 对象是着色器程序和其他信息的封装器。
- ShaderLab - 一种用于编写着色器的 Unity 特定语言。
- Shader Graph - 一种无需编写代码即可创建着色器的工具。
- 着色器资源 - Unity 项目中扩展名为 .shader 的文件。即使用代码定义的一个 Shader 对象。
- Shader Graph 资源 - Unity 项目中的 Shader Graph 文件。即使用 Shader Graph 定义的一个 Shader 对象。

## 4. Shader 使用过程（着色器加载）

### 4.1 默认加载过程

默认情况下，Unity 的运行时着色器加载行为如下：

1. 当 Unity 加载场景或使用在运行时加载资源功能加载内容时，它会将所有需要的 Shader 对象加载到 CPU 内存。
2. Unity 第一次需要使用着色器变体渲染几何体时，它将该变体的数据传递给图形驱动程序。图形驱动程序在 GPU 上创建该变体的表示，并执行平台所需的任何其他工作。

- 优点:  
   这种行为的好处是着色器变体没有前期的 GPU 内存使用或加载时间
- 缺点：  
  第一次使用变体时可能会出现明显的停顿，因为图形驱动程序必须在 GPU 上创建着色器程序并执行任何额外的工作。

### 4.2 预热着色器变体

为避免在性能开销大时出现明显的停顿，Unity 可以要求图形驱动程序在首次需要着色器变体之前创建它们的 GPU 表示形式。这称为预热。

> 注意：  
> 警告：在选择如何执行预热之前，请查看有关图形 API 支持的说明。在 DX12、Vulkan 和 Metal 等现代图形 API 上，只有实验性的 ShaderWarmup API 完全支持，因为它允许您指定顶点格式。使用其他方法可能会导致浪费工作和 GPU 内存，而不会避免停顿。

## 5. 内置着色器

Unity 内置的着色器，可以直接配置后使用，不用从零开始编程

不同的渲染管线与不同的内置着色器兼容。

![](../imgs/unity_building_shader.png)

## 6. Physically Based Shading 基于物理着色

### 6.1 物理着色 PBS

基于物理着色 (PBS) 以一种模仿现实的方式模拟材质和光照之间的相互作用。

PBR 模拟现实世界的物理原理和光，以在 3D 表面上生成逼真的阴影、反射、环境光和其他光效果。

在下图中，每个表面的外观随着场景中光线的变化而变化。每个图像中表面的属性都是相同的——只是光的颜色和方向发生了变化。

<video id="video" controls="" preload="none" poster="封面">
      <source id="mp4" src="../imgs/PBRExample.mp4" type="video/mp4">
</videos>

### 6.2 non-Physically Based Rendering 非物理着色 NPBS

渲染的颜色、阴影和反射要么在没有 PBR 科学的情况下进行近似，要么只是不渲染。

非 PBR 通常看起来不像 PBR 那样逼真，但对于风格化效果可能更理想。使 3D 场景中的表面看起来像 2D 卡通的卡通着色器是一种非 PBR 着色器。

![](../imgs/npbs.png)
